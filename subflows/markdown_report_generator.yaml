id: markdown_report_generator
namespace: subflows

description: |
  Reusable subflow that generates formatted markdown reports from analyzed content.
  Supports different report types: daily briefing or weekly summary.

inputs:
  - id: analyzed_content
    type: JSON
    description: "Analyzed content from claude_content_analyzer subflow"

  - id: report_type
    type: STRING
    description: "Type of report: 'daily' or 'weekly'"
    defaults: "daily"

  - id: report_date
    type: STRING
    description: "Date for report filename (YYYY-MM-DD format)"

  - id: feed_status
    type: JSON
    description: "Feed status data (for daily reports only)"
    required: false

tasks:
  - id: generate_report
    type: io.kestra.plugin.scripts.shell.Commands
    description: Generate markdown report based on report type
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker
      image: nezhar/claude-container:latest
      user: "1000:1000"
    env:
      CLAUDE_CODE_OAUTH_TOKEN: "{{ globals['claude-code-oauth-token'] }}"
    inputFiles:
      analyzed_content.json: "{{ inputs.analyzed_content }}"
    outputFiles:
      - "*.md"
    commands:
      - |
        REPORT_DATE="{{ inputs.report_date }}"
        REPORT_TYPE="{{ inputs.report_type }}"

        {% if inputs.report_type == 'daily' %}
        # Generate daily briefing report
        cat > /tmp/report_prompt.txt << 'PROMPT_EOF'
        You are a technical writer creating a cybersecurity intelligence briefing report.

        CRITICAL: Output ONLY the markdown report with no additional explanations or wrapper text.

        Using the analyzed content provided below (in JSON format), create a complete markdown report with this structure:

        # Cybersecurity Intelligence Briefing
        **Date:** ${REPORT_DATE}
        **Period:** Last 24 hours
        **Sources:** [number from metadata] feeds monitored
        **Total Articles Analyzed:** [number from metadata]

        ---

        ## Executive Summary

        [The executive_summary from JSON]

        ---

        ## ðŸš¨ Critical Alerts

        [For each item in critical_alerts array, format as:]
        ### [title]
        **Source:** [source] | **Date:** [date]

        [summary]

        **Impact:** [impact]
        **Affected Systems:** [affected_systems]
        **Recommended Actions:** [recommended_actions]

        [Link]([link])

        ## Vulnerabilities & Patches

        [Format items from vulnerabilities array similarly]

        ## Breaches & Incidents

        [Format items from breaches_incidents array]

        ## Advisories & Warnings

        [Format items from advisories array]

        ## Industry News

        [Format items from industry_news array]

        ---

        ## Feed Health Status

        [List each feed from feed_status with âœ… success or âš ï¸ error status and article counts]

        ---

        *Generated by Kestra Cybersecurity Intelligence Briefing*

        Here is the analyzed content JSON to convert to markdown:
        PROMPT_EOF
        {% else %}
        # Generate weekly summary report
        cat > /tmp/report_prompt.txt << 'PROMPT_EOF'
        You are a technical writer creating a weekly cybersecurity intelligence summary.

        CRITICAL: Output ONLY the markdown report with no additional explanations or wrapper text.

        Using the analyzed content provided below (in JSON format), create a complete markdown report with this structure:

        # Cybersecurity Weekly Summary
        **Week Ending:** ${REPORT_DATE}
        **Period:** [date_range from metadata]
        **Daily Reports Analyzed:** [reports_analyzed from metadata]

        ---

        ## Executive Summary

        [The executive_summary from JSON]

        ---

        ## Top Critical Items of the Week

        [For each item in top_critical_items array, format as:]
        ### [title]
        **Mentioned:** [days_mentioned] days | **Trend:** [trend]

        [summary]

        **Impact:** [impact]
        **Recommended Actions:** [recommended_actions]

        ---

        ## Trend Analysis

        ### Emerging Threats
        [List items from trends.emerging_threats as bullet points]

        ### Persistent Vulnerabilities
        [List items from trends.persistent_vulnerabilities as bullet points]

        ### Patches & Mitigations
        [List items from trends.patches_mitigations as bullet points]

        ---

        ## Daily Report Archive

        Links to individual daily reports from this week (if available in your namespace files)

        ---

        *Generated by Kestra Cybersecurity Weekly Summary*

        Here is the analyzed content JSON to convert to markdown:
        PROMPT_EOF
        {% endif %}

        cat analyzed_content.json >> /tmp/report_prompt.txt

        # Run Claude to generate the markdown report
        {% if inputs.report_type == 'daily' %}
        FILENAME="briefing-${REPORT_DATE}.md"
        {% else %}
        FILENAME="weekly-summary-${REPORT_DATE}.md"
        {% endif %}

        claude --dangerously-skip-permissions --print "$(cat /tmp/report_prompt.txt)" > "${FILENAME}" || \
        echo "# Error\nFailed to generate ${REPORT_TYPE} report. See logs for details." > "${FILENAME}"

        # Debug output
        echo "=== Report File Debug ==="
        ls -lh "${FILENAME}"
        echo "First 500 characters:"
        head -c 500 "${FILENAME}"
        echo ""
        echo "=== End Debug ==="

outputs:
  - id: report_file
    type: STRING
    value: "{{ inputs.report_type == 'daily' ? 'briefing-' ~ inputs.report_date ~ '.md' : 'weekly-summary-' ~ inputs.report_date ~ '.md' }}"
