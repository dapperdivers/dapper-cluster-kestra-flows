id: markdown_report_generator
namespace: subflows

description: |
  Reusable subflow that generates formatted markdown reports from analyzed content.
  Supports different report types: daily briefing or weekly summary.

inputs:
  - id: analyzed_content
    type: JSON
    description: "Analyzed content from claude_content_analyzer subflow"

  - id: report_type
    type: STRING
    description: "Type of report: 'daily' or 'weekly'"
    defaults: "daily"

  - id: report_date
    type: STRING
    description: "Date for report filename (YYYY-MM-DD format)"

  - id: feed_status
    type: JSON
    description: "Feed status data (for daily reports only)"
    required: false

tasks:
  - id: generate_report
    type: io.kestra.plugin.scripts.shell.Commands
    description: Generate markdown report based on report type
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker
      image: nezhar/claude-container:latest
      user: "1000:1000"
    env:
      CLAUDE_CODE_OAUTH_TOKEN: "{{ globals['claude-code-oauth-token'] }}"
    outputFiles:
      - "*.md"
    commands:
      - |
        # Stage analyzed content in workspace for Claude CLI
        cat > analyzed_content.json << 'DATA_EOF'
        {{ inputs.analyzed_content }}
        DATA_EOF

        REPORT_DATE="{{ inputs.report_date }}"
        REPORT_TYPE="{{ inputs.report_type }}"

        {% if inputs.report_type == 'daily' %}
        # Generate daily briefing report - create CLAUDE.md with instructions
        cat > CLAUDE.md << 'PROMPT_EOF'
        # Cybersecurity Briefing Report Generation Task

        You are a technical writer creating a cybersecurity intelligence briefing report.

        ## Step 1: Read and Analyze the Data
        First, read and examine the `analyzed_content.json` file in your workspace. This contains the analyzed cybersecurity intelligence.

        ## Step 2: Generate Markdown Report
        Using the analyzed content, create a complete markdown report with this structure:

        # Cybersecurity Intelligence Briefing
        **Date:** ${REPORT_DATE}
        **Period:** Last 24 hours
        **Sources:** [number from metadata] feeds monitored
        **Total Articles Analyzed:** [number from metadata]

        ---

        ## Executive Summary

        [The executive_summary from JSON]

        ---

        ## ðŸš¨ Critical Alerts

        [For each item in critical_alerts array, format as:]
        ### [title]
        **Source:** [source] | **Date:** [date]

        [summary]

        **Impact:** [impact]
        **Affected Systems:** [affected_systems]
        **Recommended Actions:** [recommended_actions]

        [Link]([link])

        ## Vulnerabilities & Patches

        [Format items from vulnerabilities array similarly]

        ## Breaches & Incidents

        [Format items from breaches_incidents array]

        ## Advisories & Warnings

        [Format items from advisories array]

        ## Industry News

        [Format items from industry_news array]

        ---

        ## Feed Health Status

        [List each feed from feed_status with âœ… success or âš ï¸ error status and article counts]

        ---

        *Generated by Kestra Cybersecurity Intelligence Briefing*

        ## Step 3: Output Requirements
        CRITICAL - Write the markdown report to `briefing-${REPORT_DATE}.md` with these requirements:
        1. Output ONLY the markdown report - no explanations, no wrapper text
        2. Do NOT include any conversational text before or after the report
        3. Use the Write tool to create the file
        PROMPT_EOF
        {% else %}
        # Generate weekly summary report - create CLAUDE.md with instructions
        cat > CLAUDE.md << 'PROMPT_EOF'
        # Weekly Cybersecurity Summary Generation Task

        You are a technical writer creating a weekly cybersecurity intelligence summary.

        ## Step 1: Read and Analyze the Data
        First, read and examine the `analyzed_content.json` file in your workspace. This contains the weekly analysis.

        ## Step 2: Generate Markdown Report
        Using the analyzed content, create a complete markdown report with this structure:

        # Cybersecurity Weekly Summary
        **Week Ending:** ${REPORT_DATE}
        **Period:** [date_range from metadata]
        **Daily Reports Analyzed:** [reports_analyzed from metadata]

        ---

        ## Executive Summary

        [The executive_summary from JSON]

        ---

        ## Top Critical Items of the Week

        [For each item in top_critical_items array, format as:]
        ### [title]
        **Mentioned:** [days_mentioned] days | **Trend:** [trend]

        [summary]

        **Impact:** [impact]
        **Recommended Actions:** [recommended_actions]

        ---

        ## Trend Analysis

        ### Emerging Threats
        [List items from trends.emerging_threats as bullet points]

        ### Persistent Vulnerabilities
        [List items from trends.persistent_vulnerabilities as bullet points]

        ### Patches & Mitigations
        [List items from trends.patches_mitigations as bullet points]

        ---

        ## Daily Report Archive

        Links to individual daily reports from this week (if available in your namespace files)

        ---

        *Generated by Kestra Cybersecurity Weekly Summary*

        ## Step 3: Output Requirements
        CRITICAL - Write the markdown report to `weekly-summary-${REPORT_DATE}.md` with these requirements:
        1. Output ONLY the markdown report - no explanations, no wrapper text
        2. Do NOT include any conversational text before or after the report
        3. Use the Write tool to create the file
        PROMPT_EOF
        {% endif %}

        # Run Claude Code with workspace context
        {% if inputs.report_type == 'daily' %}
        FILENAME="briefing-${REPORT_DATE}.md"
        {% else %}
        FILENAME="weekly-summary-${REPORT_DATE}.md"
        {% endif %}

        echo "Running Claude to generate ${REPORT_TYPE} report..."
        claude --dangerously-skip-permissions

        # Verify output exists
        if [ ! -f "${FILENAME}" ]; then
            echo "âš ï¸  Error: ${FILENAME} not created"
            echo "# Error\nFailed to generate ${REPORT_TYPE} report. Claude did not create the output file." > "${FILENAME}"
        fi

        # Debug output
        echo "=== Report File Debug ==="
        ls -lh "${FILENAME}"
        echo "First 500 characters:"
        head -c 500 "${FILENAME}"
        echo ""
        echo "=== End Debug ==="

outputs:
  - id: report_file
    type: STRING
    value: "{{ inputs.report_type == 'daily' ? 'briefing-' ~ inputs.report_date ~ '.md' : 'weekly-summary-' ~ inputs.report_date ~ '.md' }}"
